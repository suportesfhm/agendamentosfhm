<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Agende sua Visita - Maternidade</title>
  <style>
    :root{
      --container-width: 980px;
      --gap: 18px;
      --accent: #d94f72;
      --btn: #007b8f;
      --bg: #fff7f9;
    }

    html,body{
      height:100%;
      margin:0;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: var(--bg);
      color:#333;
    }

    .container{
      max-width: var(--container-width);
      margin:40px auto;
      background:#fff;
      padding:28px;
      border-radius:10px;
      box-shadow:0 6px 18px rgba(0,0,0,0.06);
    }

    h1{
      color: var(--accent);
      margin:0 0 6px;
      font-size:26px;
    }

    p.lead{
      margin:0 0 22px;
      color:#666;
      line-height:1.45;
    }

    /* GRID FORM */
    .form-grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: var(--gap);
      align-items:start;
    }

    .field{
      display:flex;
      flex-direction:column;
    }

    label{
      font-weight:600;
      margin-bottom:6px;
      font-size:13px;
    }

    input[type="text"],
    input[type="email"],
    input[type="tel"],
    input[type="number"],
    input[type="date"],
    select,
    textarea{
      border:1px solid #d0d0d0;
      border-radius:8px;
      padding:10px 12px;
      font-size:14px;
      outline:none;
      transition:box-shadow .15s, border-color .15s;
    }

    input:focus, select:focus, textarea:focus{
      box-shadow:0 0 0 3px rgba(0,123,140,0.07);
      border-color:#9fbecd;
    }

    textarea{ min-height:90px; resize:vertical; }

    /* Span helpers (12-grid) */
    .span-12{ grid-column: span 12; }
    .span-8{ grid-column: span 8; }
    .span-7{ grid-column: span 7; }
    .span-6{ grid-column: span 6; }
    .span-5{ grid-column: span 5; }
    .span-4{ grid-column: span 4; }
    .span-3{ grid-column: span 3; }

    /* Aten√ß√£o (negrito) */
    .alerta{
      font-weight:700;
      margin-top:6px;
    }
    .alerta ul{ margin:8px 0 0 0; padding-left:16px; font-weight:600; color:#444; }
    .alerta li{ margin:6px 0; }

    /* Checkbox inline + mais pr√≥ximo do bot√£o */
    .checkbox-row{
      display:flex;
      align-items:center;
      gap:12px;
      font-size:14px;
      line-height:1.2;
    }
    .checkbox-row input[type="checkbox"]{
      width:18px; height:18px;
      margin:0;
    }

    /* Bot√£o */
    .actions{ text-align:center; margin-top:6px; }
    button{
      background: var(--btn);
      color:#fff;
      border:none;
      padding:12px 22px;
      border-radius:8px;
      font-size:15px;
      cursor:pointer;
      transition: all 0.3s ease;
    }
    button:hover{ filter:brightness(.93); }
    button:disabled{
      background: #cccccc;
      cursor: not-allowed;
    }

    /* Loading */
    .loading{
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #ffffff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Mensagens */
    .message{
      padding: 12px;
      border-radius: 8px;
      margin: 10px 0;
      text-align: center;
      font-weight: 500;
    }

    .message.success{
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .message.error{
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    /* Debug Panel */
    .debug-panel {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      font-family: monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
    }

    .debug-title {
      font-weight: bold;
      color: #d94f72;
      margin-bottom: 8px;
    }

    /* Responsividade: tudo full-width em telas estreitas */
    @media (max-width:800px){
      .form-grid{ grid-template-columns: 1fr; gap:14px; }
      .field{ grid-column: 1 / -1; }
      .actions{ text-align:left; }
    }

    /* ajustes finos */
    .small-note{ color:#777; font-size:13px; margin-top:10px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Agende sua Visita</h1>
    <p class="lead">Teremos o maior prazer em receber voc√™ e um acompanhante para uma visita guiada √† nossa maternidade. Durante o passeio, voc√™ conhecer√° toda a estrutura, instala√ß√µes e servi√ßos oferecidos.</p>

    <!-- Painel de Debug -->
    <div class="span-12">
      <div class="debug-panel">
        <div class="debug-title">üêõ DEBUG CONSOLE</div>
        <div id="debugOutput">Aguardando a√ß√£o...</div>
      </div>
    </div>

    <form id="agendamentoForm" class="form-grid" novalidate>
      <!-- Linha 1 -->
      <div class="field span-7">
        <label for="nome">Nome Completo *</label>
        <input id="nome" name="nome" type="text" required>
      </div>

      <div class="field span-5">
        <label for="email">E-mail *</label>
        <input id="email" name="email" type="email" required>
      </div>

      <!-- Linha 2 -->
      <div class="field span-3">
        <label for="telefone">Telefone *</label>
        <input id="telefone" name="telefone" type="tel" placeholder="(00) 00000-0000" required maxlength="15">
      </div>

      <div class="field span-3">
        <label for="gestacao">Semana de Gesta√ß√£o *</label>
        <input id="gestacao" name="gestacao" type="number" min="1" max="42" required>
      </div>

      <div class="field span-6">
        <label for="obstetra">Obstetra *</label>
        <input id="obstetra" name="obstetra" type="text" required>
      </div>

      <!-- Linha 3 -->
      <div class="field span-4">
        <label for="cidade">Cidade *</label>
        <input id="cidade" name="cidade" type="text" required>
      </div>

      <div class="field span-8">
        <label for="bairro">Bairro *</label>
        <input id="bairro" name="bairro" type="text" required>
      </div>

      <!-- Linha 4 -->
      <div class="field span-3">
        <label for="data">Data *</label>
        <input id="data" name="data" type="date" required>
      </div>

      <div class="field span-3">
        <label for="horario">Hor√°rio *</label>
        <select id="horario" name="horario" required>
          <option value="">Selecione...</option>
        </select>
      </div>

      <div class="field span-3">
        <label for="plano">Possui plano de sa√∫de? *</label>
        <select id="plano" name="plano" required>
          <option value="">Selecione...</option>
          <option value="Sim">Sim</option>
          <option value="N√£o">N√£o</option>
        </select>
      </div>

      <div class="field span-3" id="field-qualplano" style="display:none;">
        <label for="qualplano">Se sim, qual?</label>
        <input id="qualplano" name="qualplano" type="text">
      </div>

      <!-- Linha 5 -->
      <div class="field span-6">
        <label for="conheceu">Como conheceu a maternidade? *</label>
        <select id="conheceu" name="conheceu" required>
          <option value="">Selecione...</option>
          <option>Indica√ß√£o de amigo(a)</option>
          <option>Redes sociais</option>
          <option>M√©dico</option>
          <option>Outros</option>
        </select>
      </div>

      <div class="field span-6">
        <label for="obs">Observa√ß√µes</label>
        <textarea id="obs" name="obs" placeholder="Se tiver alguma observa√ß√£o, escreva aqui..."></textarea>
      </div>

      <!-- Aten√ß√£o -->
      <div class="span-12">
        <div class="alerta">
          Aten√ß√£o:
          <ul>
            <li>Voc√™ poder√° levar apenas um acompanhante.</li>
            <li>Toler√¢ncia para atraso de no m√°ximo 15 minutos.</li>
            <li>Hor√°rios dispon√≠veis conforme o dia da semana.</li>
          </ul>
        </div>
      </div>

      <!-- Checkbox termos (inline e pr√≥ximo) -->
      <div class="span-12">
        <label class="checkbox-row">
          <input id="termos" name="termos" type="checkbox" required>
          Li e aceito os termos de uso dos dados conforme indicado na Pol√≠tica de Privacidade.
        </label>
      </div>

      <!-- Mensagens -->
      <div class="span-12">
        <div id="messageContainer"></div>
      </div>

      <!-- Bot√£o -->
      <div class="span-12 actions">
        <button type="submit" id="submitBtn">
          <span class="btn-text">Agendar Visita</span>
        </button>
        <button type="button" id="debugBtn" style="background: #6c757d; margin-left: 10px;">
          üêõ Teste Debug
        </button>
        <div class="small-note">* Campos obrigat√≥rios</div>
      </div>
    </form>
  </div>

  <script>
// URL DO WEB APP - ATUALIZADA
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwQd7EL1Ia8IIpP1FRX1p3Tx_Inpwb49wk7Jja84bWu7xlzaH0572t5TUSPShclX4a7/exec";

// Elementos do DOM
const selectHorario = document.getElementById('horario');
const inputData = document.getElementById('data');
const submitBtn = document.getElementById('submitBtn');
const btnText = submitBtn.querySelector('.btn-text');
const messageContainer = document.getElementById('messageContainer');
const debugOutput = document.getElementById('debugOutput');
const debugBtn = document.getElementById('debugBtn');

// ========== FUN√á√ïES DE DEBUG ==========

function logDebug(message) {
  const timestamp = new Date().toLocaleTimeString();
  const debugMessage = `[${timestamp}] ${message}`;
  console.log(debugMessage);
  debugOutput.innerHTML += debugMessage + '<br>';
  debugOutput.scrollTop = debugOutput.scrollHeight;
}

// Fun√ß√£o global para receber hor√°rios via JSONP
window.handleHorarios = function(data) {
  logDebug("üì® Resposta JSONP recebida: " + JSON.stringify(data));
  
  if (data.status === 'ok' && Array.isArray(data.horarios)) {
    selectHorario.innerHTML = '<option value="">Selecione...</option>';
    
    if (data.horarios.length > 0) {
      data.horarios.forEach(h => {
        const opt = document.createElement('option');
        opt.value = h;
        opt.textContent = h;
        selectHorario.appendChild(opt);
      });
      logDebug("‚úÖ Hor√°rios carregados: " + data.horarios.join(', '));
    } else {
      selectHorario.innerHTML = '<option value="">Sem hor√°rios dispon√≠veis</option>';
      logDebug("‚ÑπÔ∏è Sem hor√°rios dispon√≠veis para esta data");
    }
  } else {
    selectHorario.innerHTML = '<option value="">Erro ao carregar hor√°rios</option>';
    logDebug("‚ùå Erro na resposta: " + JSON.stringify(data));
  }
  
  selectHorario.disabled = false;
};

// Fun√ß√£o global para receber resposta do agendamento
window.handleAgendamento = function(data) {
  logDebug("üì® Resposta do agendamento: " + JSON.stringify(data));
  
  if (data.status === 'ok') {
    logDebug("‚úÖ Agendamento realizado com sucesso!");
    mostrarMensagem('‚úÖ Agendamento realizado com sucesso! Em breve entraremos em contato para confirma√ß√£o.', 'success');
    
    // Limpar formul√°rio
    document.getElementById('agendamentoForm').reset();
    selectHorario.innerHTML = '<option value="">Selecione...</option>';
    
    // Ocultar campo do plano
    document.getElementById('field-qualplano').style.display = 'none';
    
  } else {
    logDebug("‚ùå Erro do servidor: " + data.message);
    mostrarMensagem('‚ùå ' + (data.message || 'Erro ao realizar agendamento'), 'error');
  }
  
  setLoading(false);
};

// ========== FUN√á√ïES PRINCIPAIS ==========

// Mostrar/ocultar campo do plano de sa√∫de
document.getElementById('plano').addEventListener('change', function() {
  const qualPlanoField = document.getElementById('field-qualplano');
  const qualPlanoInput = document.getElementById('qualplano');
  
  if (this.value === 'Sim') {
    qualPlanoField.style.display = 'flex';
    qualPlanoInput.required = true;
  } else {
    qualPlanoField.style.display = 'none';
    qualPlanoInput.required = false;
    qualPlanoInput.value = '';
  }
});

// Formatar telefone
document.getElementById('telefone').addEventListener('input', function(e) {
  let value = e.target.value.replace(/\D/g, '');
  
  if (value.length <= 11) {
    if (value.length === 11) {
      value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
    } else if (value.length === 10) {
      value = value.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
    } else if (value.length > 6) {
      value = value.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
    } else if (value.length > 2) {
      value = value.replace(/(\d{2})(\d{0,5})/, '($1) $2');
    } else if (value.length > 0) {
      value = value.replace(/(\d{0,2})/, '($1');
    }
    
    e.target.value = value;
  }
});

// Carrega hor√°rios dispon√≠veis quando muda a data usando JSONP
function carregarHorariosParaData(dataSelecionada) {
  logDebug("üîÑ Carregando hor√°rios para data: " + dataSelecionada);
  
  selectHorario.innerHTML = '<option value="">Carregando...</option>';
  selectHorario.disabled = true;
  
  if (!dataSelecionada) {
    selectHorario.innerHTML = '<option value="">Selecione uma data</option>';
    selectHorario.disabled = false;
    return;
  }

  try {
    // Usando JSONP para evitar CORS
    const url = `${WEB_APP_URL}?acao=listarHorariosDisponiveis&data=${encodeURIComponent(dataSelecionada)}&callback=handleHorarios`;
    logDebug("üîó URL JSONP: " + url);
    
    // Remover script anterior se existir
    const scriptAntigo = document.getElementById('jsonp-script');
    if (scriptAntigo) {
      scriptAntigo.remove();
    }
    
    // Criar novo script para JSONP
    const script = document.createElement('script');
    script.id = 'jsonp-script';
    script.src = url;
    script.onerror = function() {
      logDebug("‚ùå Erro ao carregar script JSONP");
      selectHorario.innerHTML = '<option value="">Erro de conex√£o</option>';
      selectHorario.disabled = false;
    };
    
    document.head.appendChild(script);
    
  } catch (err) {
    logDebug("üí• Erro ao carregar hor√°rios: " + err);
    selectHorario.innerHTML = '<option value="">Erro de conex√£o</option>';
    selectHorario.disabled = false;
  }
}

// Event listener para mudan√ßa de data
inputData.addEventListener('change', function() {
  carregarHorariosParaData(this.value);
});

// Mostrar mensagem
function mostrarMensagem(mensagem, tipo) {
  messageContainer.innerHTML = `<div class="message ${tipo}">${mensagem}</div>`;
  
  if (tipo === 'success') {
    setTimeout(() => {
      messageContainer.innerHTML = '';
    }, 5000);
  }
}

// Ativar/desativar bot√£o de envio
function setLoading(loading) {
  if (loading) {
    submitBtn.disabled = true;
    btnText.innerHTML = '<div class="loading"></div>Enviando...';
  } else {
    submitBtn.disabled = false;
    btnText.textContent = 'Agendar Visita';
  }
}

// ========== ENVIO DO FORMUL√ÅRIO COM DEBUG ==========

document.getElementById('agendamentoForm').addEventListener('submit', function(e) {
  e.preventDefault();
  logDebug("=== üöÄ INICIANDO AGENDAMENTO ===");
  
  // Valida√ß√£o dos termos
  if (!document.getElementById('termos').checked) {
    mostrarMensagem('Voc√™ precisa aceitar os termos de uso antes de enviar.', 'error');
    logDebug("‚ùå Termos n√£o aceitos");
    return;
  }

  // Coletar dados do formul√°rio
  const dados = {
    nome: document.getElementById('nome').value.trim(),
    email: document.getElementById('email').value.trim(),
    telefone: document.getElementById('telefone').value.trim(),
    semanaGestacao: document.getElementById('gestacao').value.trim(),
    obstetra: document.getElementById('obstetra').value.trim(),
    cidade: document.getElementById('cidade').value.trim(),
    bairro: document.getElementById('bairro').value.trim(),
    data: document.getElementById('data').value,
    horario: document.getElementById('horario').value,
    planoSaude: document.getElementById('plano').value,
    qualPlano: document.getElementById('qualplano').value.trim(),
    comoConheceu: document.getElementById('conheceu').value,
    observacoes: document.getElementById('obs').value.trim()
  };

  logDebug("üìù Dados coletados: " + JSON.stringify(dados));

  // Validar campos obrigat√≥rios
  const camposObrigatorios = ['nome', 'email', 'telefone', 'data', 'horario', 'planoSaude', 'comoConheceu'];
  const camposVazios = camposObrigatorios.filter(campo => !dados[campo]);
  
  if (camposVazios.length > 0) {
    mostrarMensagem('Preencha todos os campos obrigat√≥rios marcados com *', 'error');
    logDebug("‚ùå Campos vazios: " + camposVazios.join(', '));
    return;
  }

  // Validar email
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(dados.email)) {
    mostrarMensagem('Por favor, insira um email v√°lido', 'error');
    logDebug("‚ùå Email inv√°lido: " + dados.email);
    return;
  }

  setLoading(true);
  mostrarMensagem('', '');

  logDebug("üîÑ Enviando via GET parameters + JSONP...");

  // Construir URL com par√¢metros (encode todos os valores)
  let urlParams = `nome=${encodeURIComponent(dados.nome)}`;
  urlParams += `&email=${encodeURIComponent(dados.email)}`;
  urlParams += `&telefone=${encodeURIComponent(dados.telefone)}`;
  urlParams += `&semanaGestacao=${encodeURIComponent(dados.semanaGestacao)}`;
  urlParams += `&obstetra=${encodeURIComponent(dados.obstetra)}`;
  urlParams += `&cidade=${encodeURIComponent(dados.cidade)}`;
  urlParams += `&bairro=${encodeURIComponent(dados.bairro)}`;
  urlParams += `&data=${encodeURIComponent(dados.data)}`;
  urlParams += `&horario=${encodeURIComponent(dados.horario)}`;
  urlParams += `&planoSaude=${encodeURIComponent(dados.planoSaude)}`;
  urlParams += `&qualPlano=${encodeURIComponent(dados.qualPlano)}`;
  urlParams += `&comoConheceu=${encodeURIComponent(dados.comoConheceu)}`;
  urlParams += `&observacoes=${encodeURIComponent(dados.observacoes)}`;
  urlParams += `&callback=handleAgendamento`;

  const urlComParams = `${WEB_APP_URL}?${urlParams}`;
  logDebug("üîó URL completa: " + urlComParams);

  // Remover script anterior se existir
  const scriptAntigo = document.getElementById('agendamento-script');
  if (scriptAntigo) {
    scriptAntigo.remove();
  }
  
  // Criar script para JSONP
  const script = document.createElement('script');
  script.id = 'agendamento-script';
  script.src = urlComParams;
  script.onerror = function() {
    logDebug("‚ùå Erro ao carregar script de agendamento");
    mostrarMensagem('‚ùå Erro de conex√£o. Tente novamente.', 'error');
    setLoading(false);
  };
  
  document.head.appendChild(script);
});

// ========== BOT√ÉO DE DEBUG ==========

debugBtn.addEventListener('click', function() {
  logDebug("=== üß™ TESTE DEBUG MANUAL ===");
  
  // Preencher dados de teste
  document.getElementById('nome').value = 'Teste Debug';
  document.getElementById('email').value = 'debug@teste.com';
  document.getElementById('telefone').value = '(11) 99999-9999';
  document.getElementById('gestacao').value = '30';
  document.getElementById('obstetra').value = 'Dr. Teste';
  document.getElementById('cidade').value = 'S√£o Paulo';
  document.getElementById('bairro').value = 'Centro';
  document.getElementById('data').value = '2024-12-20';
  document.getElementById('plano').value = 'Sim';
  document.getElementById('qualplano').value = 'Unimed';
  document.getElementById('conheceu').value = 'Indica√ß√£o de amigo(a)';
  document.getElementById('termos').checked = true;
  
  logDebug("‚úÖ Formul√°rio preenchido com dados de teste");
  logDebug("üí° Agora clique em 'Agendar Visita' para testar o envio");
});

// ========== TESTES MANUAIS ==========

// Teste de comunica√ß√£o manual
window.testarAgendamentoManual = function() {
  logDebug("=== üß™ TESTE MANUAL VIA URL ===");
  
  const urlTeste = `${WEB_APP_URL}?nome=TesteManual&email=manual@teste.com&telefone=11999999999&data=2024-12-20&horario=10:00&callback=handleAgendamento`;
  logDebug("üîó URL de teste: " + urlTeste);
  
  const script = document.createElement('script');
  script.src = urlTeste;
  document.head.appendChild(script);
};

// Teste de hor√°rios manual
window.testarHorarios = function() {
  const dataTeste = '2024-12-20';
  logDebug("üß™ Testando hor√°rios para: " + dataTeste);
  carregarHorariosParaData(dataTeste);
};

logDebug("‚úÖ P√°gina de agendamento carregada!");
logDebug("üîó Web App URL: " + WEB_APP_URL);
logDebug("üí° Comandos de teste:");
logDebug("   - testarHorarios() - Testa carregamento de hor√°rios");
logDebug("   - testarAgendamentoManual() - Testa envio manual");
  </script>
</body>
</html>

