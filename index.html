<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Agende sua Visita - Maternidade</title>
  <style>
    :root {
      --accent: #d94f72;
      --btn: #007b8f;
      --bg: #fff7f9;
    }

    body {
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: var(--bg);
      margin: 0;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 960px;
      margin: 40px auto;
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
    }

    h1 {
      color: var(--accent);
      margin-bottom: 10px;
    }

    p.lead {
      color: #555;
      margin-bottom: 25px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 16px;
    }

    .field {
      display: flex;
      flex-direction: column;
    }

    label {
      font-weight: 600;
      margin-bottom: 5px;
      font-size: 13px;
    }

    input, select, textarea {
      border: 1px solid #d0d0d0;
      border-radius: 8px;
      padding: 10px;
      font-size: 14px;
      outline: none;
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(217, 79, 114, 0.1);
    }

    textarea { min-height: 80px; resize: vertical; }

    .span-12 { grid-column: span 12; }
    .span-6 { grid-column: span 6; }
    .span-4 { grid-column: span 4; }
    .span-3 { grid-column: span 3; }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    button {
      background: var(--btn);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    button:hover { filter: brightness(0.95); }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .message {
      padding: 12px;
      border-radius: 8px;
      margin: 10px 0;
      text-align: center;
      font-weight: 500;
    }

    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .alerta {
      font-weight: 700;
      margin-top: 15px;
    }

    .alerta ul {
      margin: 8px 0 0 20px;
    }

    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Agende sua Visita</h1>
    <p class="lead">Preencha os campos abaixo para agendar sua visita guiada √† maternidade.</p>

    <form id="agendamentoForm" class="form-grid" novalidate>
      <div class="field span-7">
        <label for="nome">Nome Completo *</label>
        <input id="nome" type="text" required>
      </div>
      <div class="field span-5">
        <label for="email">E-mail *</label>
        <input id="email" type="email" required>
      </div>
      <div class="field span-3">
        <label for="telefone">Telefone *</label>
        <input id="telefone" type="tel" placeholder="(00) 00000-0000" required maxlength="15">
      </div>
      <div class="field span-3">
        <label for="gestacao">Semana de Gesta√ß√£o *</label>
        <input id="gestacao" type="number" min="1" max="42" required>
      </div>
      <div class="field span-6">
        <label for="obstetra">Obstetra *</label>
        <input id="obstetra" type="text" required>
      </div>
      <div class="field span-4">
        <label for="cidade">Cidade *</label>
        <input id="cidade" type="text" required>
      </div>
      <div class="field span-8">
        <label for="bairro">Bairro *</label>
        <input id="bairro" type="text" required>
      </div>
      <div class="field span-3">
        <label for="data">Data *</label>
        <input id="data" type="date" required>
      </div>
      <div class="field span-3">
        <label for="horario">Hor√°rio *</label>
        <select id="horario" required>
          <option value="">Selecione...</option>
        </select>
      </div>
      <div class="field span-3">
        <label for="plano">Possui plano de sa√∫de? *</label>
        <select id="plano" required>
          <option value="">Selecione...</option>
          <option value="Sim">Sim</option>
          <option value="N√£o">N√£o</option>
        </select>
      </div>
      <div class="field span-3" id="field-qualplano" style="display:none;">
        <label for="qualplano">Se sim, qual?</label>
        <input id="qualplano" type="text">
      </div>
      <div class="field span-6">
        <label for="conheceu">Como conheceu a maternidade? *</label>
        <select id="conheceu" required>
          <option value="">Selecione...</option>
          <option>Indica√ß√£o de amigo(a)</option>
          <option>Redes sociais</option>
          <option>M√©dico</option>
          <option>Outros</option>
        </select>
      </div>
      <div class="field span-6">
        <label for="obs">Observa√ß√µes</label>
        <textarea id="obs" placeholder="Escreva aqui..."></textarea>
      </div>

      <div class="span-12 alerta">
        Aten√ß√£o:
        <ul>
          <li>Voc√™ poder√° levar apenas um acompanhante.</li>
          <li>Toler√¢ncia para atraso de no m√°ximo 15 minutos.</li>
        </ul>
      </div>

      <div class="span-12 checkbox-row">
        <input id="termos" type="checkbox" required>
        <label for="termos">Li e aceito os termos de uso dos dados conforme indicado na Pol√≠tica de Privacidade.</label>
      </div>

      <div class="span-12" id="messageContainer"></div>

      <div class="span-12">
        <button type="submit" id="submitBtn">
          <span class="btn-text">Agendar Visita</span>
        </button>
      </div>
    </form>
  </div>

  <script>
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbymcGV_VzLEae1NS6_sJ6w8lsPmc1VJyjHfXSVXpE-lspXy63gc3Khtkujuowtv-qDW/exec";

  const selectHorario = document.getElementById('horario');
  const inputData = document.getElementById('data');
  const messageContainer = document.getElementById('messageContainer');
  const submitBtn = document.getElementById('submitBtn');
  const btnText = submitBtn.querySelector('.btn-text');

  // ============================
  // CALLBACK JSONP: hor√°rios
  // ============================
  window.handleHorarios = function(data) {
    console.log("üü¢ handleHorarios recebeu:", data);

    selectHorario.innerHTML = '<option value="">Selecione...</option>';

    if (data && data.status === 'ok' && Array.isArray(data.horarios)) {
      if (data.horarios.length > 0) {
        data.horarios.forEach(h => {
          const opt = document.createElement('option');
          opt.value = h;
          opt.textContent = h;
          selectHorario.appendChild(opt);
        });
      } else {
        selectHorario.innerHTML = '<option value="">Sem hor√°rios dispon√≠veis</option>';
      }
    } else {
      selectHorario.innerHTML = '<option value="">Erro ao carregar hor√°rios</option>';
    }

    selectHorario.disabled = false;
  };

  // ============================
  // CALLBACK JSONP: agendamento
  // ============================
  window.handleAgendamento = function(data) {
    console.log("üì¶ handleAgendamento:", data);
    if (data.status === 'ok') {
      mostrarMensagem('‚úÖ Agendamento realizado com sucesso!', 'success');
      document.getElementById('agendamentoForm').reset();
      selectHorario.innerHTML = '<option value="">Selecione...</option>';
    } else {
      mostrarMensagem('‚ùå ' + (data.message || 'Erro ao enviar.'), 'error');
    }
    setLoading(false);
  };

  // ============================
  // Carregar hor√°rios por data
  // ============================
  function carregarHorariosParaData(dataSelecionada) {
    if (!dataSelecionada) return;
    selectHorario.innerHTML = '<option>Carregando...</option>';
    selectHorario.disabled = true;

    const url = `${WEB_APP_URL}?acao=listarHorariosDisponiveis&data=${encodeURIComponent(dataSelecionada)}&callback=handleHorarios&_=${Date.now()}`;
    console.log("üîó Requisitando hor√°rios:", url);

    const scriptAntigo = document.getElementById('jsonp-script');
    if (scriptAntigo) scriptAntigo.remove();

    const script = document.createElement('script');
    script.id = 'jsonp-script';
    script.src = url;
    script.onerror = function() {
      console.error("‚ùå Erro ao conectar ao Apps Script");
      selectHorario.innerHTML = '<option value="">Erro de conex√£o</option>';
      selectHorario.disabled = false;
    };

    document.head.appendChild(script);
  }

  inputData.addEventListener('change', () => carregarHorariosParaData(inputData.value));

  // ============================
  // Enviar agendamento
  // ============================
  document.getElementById('agendamentoForm').addEventListener('submit', function(e) {
    e.preventDefault();
    if (!document.getElementById('termos').checked) {
      mostrarMensagem('Voc√™ precisa aceitar os termos antes de enviar.', 'error');
      return;
    }

    const dados = {
      nome: nome.value.trim(),
      email: email.value.trim(),
      telefone: telefone.value.trim(),
      semanaGestacao: gestacao.value.trim(),
      obstetra: obstetra.value.trim(),
      cidade: cidade.value.trim(),
      bairro: bairro.value.trim(),
      data: data.value,
      horario: horario.value,
      planoSaude: plano.value,
      qualPlano: qualplano.value.trim(),
      comoConheceu: conheceu.value,
      observacoes: obs.value.trim()
    };

    const camposObrigatorios = ['nome','email','telefone','data','horario'];
    if (camposObrigatorios.some(c => !dados[c])) {
      mostrarMensagem('Preencha todos os campos obrigat√≥rios.', 'error');
      return;
    }

    setLoading(true);

    let urlParams = Object.entries(dados)
      .map(([k,v]) => `${k}=${encodeURIComponent(v)}`)
      .join('&');
    urlParams += '&callback=handleAgendamento';

    const url = `${WEB_APP_URL}?${urlParams}`;
    console.log("üöÄ Enviando agendamento:", url);

    const oldScript = document.getElementById('agendamento-script');
    if (oldScript) oldScript.remove();

    const script = document.createElement('script');
    script.id = 'agendamento-script';
    script.src = url;
    script.onerror = function() {
      mostrarMensagem('‚ùå Erro de conex√£o. Tente novamente.', 'error');
      setLoading(false);
    };
    document.head.appendChild(script);
  });

  // ============================
  // Utilit√°rios
  // ============================
  function mostrarMensagem(msg, tipo) {
    messageContainer.innerHTML = `<div class="message ${tipo}">${msg}</div>`;
    if (tipo === 'success') setTimeout(() => messageContainer.innerHTML = '', 4000);
  }

  function setLoading(loading) {
    if (loading) {
      submitBtn.disabled = true;
      btnText.textContent = 'Enviando...';
    } else {
      submitBtn.disabled = false;
      btnText.textContent = 'Agendar Visita';
    }
  }

  console.log("‚úÖ Sistema de agendamento carregado!");
  </script>
</body>
</html>
