<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Painel de Controle - Agendamentos</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root {
      --accent: #d94f72;
      --btn: #007b8f;
      --bg: #fff7f9;
      --card-bg: #ffffff;
      --text: #333333;
      --light-text: #666666;
    }
    * { box-sizing: border-box; }
    body{ font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:var(--bg); margin:0; padding:20px; color:var(--text); min-height:100vh; }

    /* Login */
    .login-container{ max-width:400px; width:90%; margin:40px auto; background:var(--card-bg); padding:40px 30px; border-radius:20px; box-shadow:0 15px 35px rgba(0,0,0,0.1); text-align:center; }
    .login-icon{ width:80px; height:80px; background:var(--accent); border-radius:50%; margin:0 auto 20px; display:flex; align-items:center; justify-content:center; color:white; font-size:32px; }
    .login-title{ color:var(--accent); margin:0 0 10px 0; font-size:24px; font-weight:700; }
    .form-group{ margin-bottom:20px; text-align:left; }
    .form-group label{ display:block; margin-bottom:8px; font-weight:600; font-size:14px; }
    .form-group input{ width:100%; padding:15px; border:2px solid #e9ecef; border-radius:12px; font-size:16px; background:#f8f9fa; }
    .login-btn{ width:100%; padding:15px; background:var(--accent); color:white; border:none; border-radius:12px; font-size:16px; font-weight:600; cursor:pointer; margin-top:10px; }
    .login-btn:hover{ transform:translateY(-2px); box-shadow:0 8px 20px rgba(217,79,114,0.3); }

    /* Panel */
    .panel-container{ max-width:1200px; width:95%; margin:40px auto; background:var(--card-bg); padding:40px; border-radius:15px; box-shadow:0 8px 25px rgba(0,0,0,0.1); }
    h1{ text-align:center; color:var(--accent); margin-bottom:30px; font-size:28px; }
    input, button, select { padding:12px; margin-top:8px; border-radius:8px; border:1px solid #d0d0d0; font-size:15px; box-sizing:border-box; }
    button{ background:var(--btn); color:#fff; border:none; cursor:pointer; transition:all .3s ease; }
    .btn-red{ background:#d9534f; } .btn-green{ background:#5cb85c; } .btn-small{ padding:8px 16px; font-size:14px; width:auto; } .logout{ text-align:right; margin-bottom:20px; }

    .filtros-container{ background:#f8f9fa; padding:20px; border-radius:10px; margin-bottom:30px; display:grid; grid-template-columns:1fr 1fr 1fr auto; gap:15px; align-items:end; }
    @media(max-width:768px){ .filtros-container{ grid-template-columns:1fr; } .panel-container{ padding:20px; } }

    .agendamentos-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(320px,1fr)); gap:20px; margin-top:20px; }
    .agendamento-card{ background:var(--card-bg); border:1px solid #e9ecef; border-radius:12px; padding:20px; box-shadow:0 4px 12px rgba(0,0,0,0.08); transition:all .3s ease; }
    .agendamento-card:hover{ transform:translateY(-5px); box-shadow:0 8px 20px rgba(0,0,0,0.15); }
    .card-header{ border-bottom:2px solid var(--accent); padding-bottom:10px; margin-bottom:15px; }
    .paciente-nome{ font-size:18px; font-weight:bold; color:var(--accent); margin:0; }
    .agendamento-info{ font-size:14px; margin:8px 0; color:var(--light-text); }
    .info-label{ font-weight:600; color:var(--text); }

    .status-badge{ display:inline-block; padding:4px 12px; border-radius:20px; font-size:12px; font-weight:bold; margin-top:10px; }
    .status-pendente{ background:#fff3cd; color:#856404; } .status-confirmado{ background:#d1edff; color:#004085; }

    .stats-container{ display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:15px; margin-bottom:30px; }
    .stat-card{ background:var(--card-bg); padding:20px; border-radius:10px; text-align:center; box-shadow:0 4px 12px rgba(0,0,0,0.08); }
    .stat-number{ font-size:32px; font-weight:bold; color:var(--accent); margin:10px 0; }
    .stat-label{ color:var(--light-text); font-size:14px; }

    .notice{ padding:15px; border-radius:8px; margin:15px 0; text-align:center; }
    .notice.success{ background:#d4edda; color:#155724; border:1px solid #c3e6cb; } .notice.error{ background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }

    .empty-state{ text-align:center; padding:40px; color:var(--light-text); } .export-section{ text-align:right; margin-bottom:20px; }
  </style>
</head>
<body>
  <!-- Login -->
  <div class="login-container" id="loginDiv">
    <div class="login-header">
      <div class="login-icon">🔐</div>
      <h1 class="login-title">Painel Administrativo</h1>
      <p class="login-subtitle">Acesse o sistema de agendamentos</p>
    </div>

    <div class="login-form">
      <div class="form-group">
        <label for="user">Usuário:</label>
        <input type="text" id="user" placeholder="Digite seu usuário" />
      </div>

      <div class="form-group">
        <label for="pass">Senha:</label>
        <input type="password" id="pass" placeholder="Digite sua senha" />
      </div>

      <button type="button" class="login-btn" id="loginBtn">Entrar no Sistema</button>
      <div id="loginNotice" style="margin-top:12px;color:#b00;display:none;"></div>
    </div>
  </div>

  <!-- Painel -->
  <div class="panel-container" id="panelDiv" style="display:none;">
    <div class="logout">
      <button type="button" class="btn-red btn-small" id="logoutBtn">Sair</button>
    </div>

    <h1>Painel de Controle - Agendamentos</h1>

    <div class="stats-container" id="statsContainer">
      <div class="stat-card">
        <div class="stat-label">Total de Agendamentos</div>
        <div class="stat-number" id="totalAgendamentos">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Agendamentos Hoje</div>
        <div class="stat-number" id="agendamentosHoje">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Agendamentos no mês</div>
        <div class="stat-number" id="agendamentosNoMes">0</div>
      </div>
    </div>

    <div class="filtros-container">
      <div class="field">
        <label for="filtroNome">Filtrar por Nome:</label>
        <input type="text" id="filtroNome" placeholder="Digite o nome do paciente">
      </div>
      <div class="field">
        <label for="filtroData">Filtrar por Data:</label>
        <input type="date" id="filtroData">
      </div>
      <div class="field">
        <label for="filtroHorario">Filtrar por Horário:</label>
        <input type="time" id="filtroHorario">
      </div>
      <div class="field">
        <label>&nbsp;</label>
        <button type="button" id="aplicarFiltrosBtn">Aplicar Filtros</button>
      </div>
    </div>

    <div class="export-section">
      <button type="button" id="exportBtn" class="btn-green">📊 Exportar para Excel</button>
    </div>

    <div id="agendamentosContainer">
      <div class="agendamentos-grid" id="agendamentosGrid"></div>
    </div>

    <div class="notice" id="panelNotice" style="display:none;"></div>
  </div>

  <script>
    // ============ CONFIG ============
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyyKOvISjd_OcJ53l55xXMiFehhGOlV50HFGCQ7cyS_B6w0h1cQD7_TCzOTw4HKKWic/exec";
    const LOGIN_USER = "admin";
    const LOGIN_PASS = "1234";

    // armazenamento
    let FULL_AGENDAMENTOS = [];   // dados brutos carregados do servidor (normalizados em _dateISO/_time)
    let SHOWN_AGENDAMENTOS = [];  // dados filtrados que estão sendo exibidos/exportados

    // ============ HELPERS ============
    function pad2(n){ return String(n).padStart(2,'0'); }

    function escapeHtml(s) {
      if (s === null || s === undefined) return '';
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'", '&#39;');
    }

    // tenta extrair YYYY-MM-DD de várias formas
    function extractDateISO(s) {
      if (!s) return '';
      s = String(s).trim();

      // já no formato yyyy-mm-dd
      let m = s.match(/\d{4}-\d{2}-\d{2}/);
      if (m) return m[0];

      // formato dd/mm/yyyy
      m = s.match(/\b(\d{2})\/(\d{2})\/(\d{4})\b/);
      if (m) {
        const [,d,mo,y] = m;
        return `${y}-${mo}-${d}`;
      }

      // tentativa com ISO ou Date parsing
      const dObj = new Date(s);
      if (!isNaN(dObj.getTime())) {
        const y = dObj.getFullYear();
        const mo = pad2(dObj.getMonth()+1);
        const da = pad2(dObj.getDate());
        return `${y}-${mo}-${da}`;
      }

      // sem sucesso
      return '';
    }

    // FUNÇÃO CORRIGIDA: Converte para os horários válidos 10:00 ou 15:00
    function extractTimeHHMM(s) {
      if (!s) return '';
      s = String(s).trim();
      
      console.log('Horário recebido:', s);

      // CASO 1: Se já estiver no formato HH:MM (10:00, 15:00, etc)
      const m = s.match(/^(\d{1,2}):(\d{2})$/);
      if (m) {
        console.log('Horário já formatado:', s);
        return s;
      }

      // CASO 2: Se for timestamp do Sheets (1899-12-30T...)
      if (s.includes('1899-12-30')) {
        console.log('Detectado formato Sheets - convertendo timestamp');
        try {
          const dObj = new Date(s);
          if (!isNaN(dObj.getTime())) {
            // O timestamp do Sheets representa um horário puro
            const horasUTC = dObj.getUTCHours();
            const minutosUTC = dObj.getUTCMinutes();
            
            console.log('Timestamp Sheets - UTC:', `${horasUTC}:${minutosUTC}`);
            
            // Converter para horário brasileiro (UTC-3)
            let horasBrasil = horasUTC - 3;
            if (horasBrasil < 0) horasBrasil += 24;
            
            const horarioExtraido = `${pad2(horasBrasil)}:${pad2(minutosUTC)}`;
            console.log('Horário Brasil (UTC-3):', horarioExtraido);
            
            // MAPEAR PARA OS HORÁRIOS VÁLIDOS
            let horarioFinal = '';
            
            // Se o horário extraído estiver próximo de 10:00 (manhã)
            if ((horasBrasil === 10 && minutosUTC >= 0 && minutosUTC <= 59) || 
                (horasBrasil === 9 && minutosUTC >= 45)) {
              horarioFinal = '10:00';
            }
            // Se o horário extraído estiver próximo de 15:00 (tarde)
            else if ((horasBrasil === 15 && minutosUTC >= 0 && minutosUTC <= 59) || 
                     (horasBrasil === 14 && minutosUTC >= 45)) {
              horarioFinal = '15:00';
            }
            // Se não se encaixar em nenhum, usar lógica baseada no período do dia
            else {
              horarioFinal = horasBrasil < 12 ? '10:00' : '15:00';
            }
            
            console.log('Horário final mapeado:', horarioFinal);
            return horarioFinal;
          }
        } catch (e) {
          console.log('Erro ao converter timestamp Sheets:', e);
        }
      }

      // CASO 3: Tentar extrair e mapear para horários válidos
      const m2 = s.match(/(\d{1,2}):(\d{2})/);
      if (m2) {
        const horas = parseInt(m2[1]);
        const minutos = parseInt(m2[2]);
        
        let horarioFinal = '';
        
        // Mapear para os horários válidos
        if ((horas === 10 && minutos >= 0 && minutos <= 59) || 
            (horas === 9 && minutos >= 45)) {
          horarioFinal = '10:00';
        } else if ((horas === 15 && minutos >= 0 && minutos <= 59) || 
                   (horas === 14 && minutos >= 45)) {
          horarioFinal = '15:00';
        } else {
          horarioFinal = horas < 12 ? '10:00' : '15:00';
        }
        
        console.log('Horário extraído e mapeado:', `${horas}:${pad2(minutos)} -> ${horarioFinal}`);
        return horarioFinal;
      }

      console.log('Nenhum horário válido encontrado');
      return '';
    }

    // normaliza um objeto agendamento
    function normalizeAg(ag, index) {
      const rawDate = ag.data || '';
      const rawTime = ag.horario || '';

      console.log(`=== Normalizando agendamento ${index} ===`);
      console.log('Nome:', ag.nome);
      console.log('Data raw:', rawDate);
      console.log('Horario raw:', rawTime);

      // Para data: extrai do campo 'data'
      let dateISO = extractDateISO(rawDate);
      if (!dateISO && ag.timestamp) dateISO = extractDateISO(ag.timestamp);

      // Para horário: usa APENAS o campo 'horario'
      const timeHH = extractTimeHHMM(rawTime);

      ag._dateISO = dateISO;
      ag._timeHHMM = timeHH;
      ag._displayDate = dateISO ? `${dateISO.split('-')[2]}/${dateISO.split('-')[1]}/${dateISO.split('-')[0]}` : '';

      console.log('Resultado final:');
      console.log('_dateISO:', ag._dateISO);
      console.log('_timeHHMM:', ag._timeHHMM);
      console.log('_displayDate:', ag._displayDate);
      console.log('================');
    }

    // ============ AUTENTICAÇÃO ============
    function showLoginNotice(msg) {
      const el = document.getElementById('loginNotice');
      if (!msg) { el.style.display = 'none'; el.textContent = ''; return; }
      el.style.display = 'block'; el.textContent = msg;
    }

    function login() {
      const u = document.getElementById('user').value.trim();
      const p = document.getElementById('pass').value.trim();
      if (u === LOGIN_USER && p === LOGIN_PASS) {
        localStorage.setItem('logado','sim');
        document.getElementById('loginDiv').style.display = 'none';
        document.getElementById('panelDiv').style.display = 'block';
        carregarAgendamentos();
        showLoginNotice(null);
      } else {
        showLoginNotice('Usuário ou senha incorretos.');
      }
    }

    function logout() {
      localStorage.removeItem('logado');
      document.getElementById('panelDiv').style.display = 'none';
      document.getElementById('loginDiv').style.display = 'block';
      document.getElementById('user').value = '';
      document.getElementById('pass').value = '';
      FULL_AGENDAMENTOS = [];
      SHOWN_AGENDAMENTOS = [];
    }

    // ============ CARREGAR & FILTRAR ============
    async function carregarAgendamentos() {
      const filtroNome = (document.getElementById('filtroNome').value || '').trim();
      const filtroData = document.getElementById('filtroData').value || '';
      const filtroHorario = document.getElementById('filtroHorario').value || '';

      const grid = document.getElementById('agendamentosGrid');
      grid.innerHTML = '<div class="empty-state">Carregando...</div>';

      try {
        const res = await fetch(`${WEB_APP_URL}?acao=listarAgendamentos`);
        if (!res.ok) throw new Error('Resposta não OK: ' + res.status);
        const dados = await res.json();
        if (dados.status !== 'ok' || !Array.isArray(dados.agendamentos)) {
          FULL_AGENDAMENTOS = [];
          SHOWN_AGENDAMENTOS = [];
          grid.innerHTML = '<div class="empty-state">Nenhum agendamento encontrado</div>';
          atualizarEstatisticas([]);
          return;
        }

        // normalizar todos os agendamentos
        FULL_AGENDAMENTOS = dados.agendamentos.filter(a => a && (a.nome || '').toString().trim() !== '');
        
        console.log('=== INICIANDO NORMALIZAÇÃO DOS DADOS ===');
        FULL_AGENDAMENTOS.forEach((ag, index) => {
          normalizeAg(ag, index);
        });
        console.log('=== FIM DA NORMALIZAÇÃO ===');

        // aplicar filtros localmente
        const nomeLower = filtroNome.toLowerCase();
        SHOWN_AGENDAMENTOS = FULL_AGENDAMENTOS.filter(ag => {
          const okNome = !filtroNome || ((ag.nome || '').toString().toLowerCase().includes(nomeLower));
          const okData = !filtroData || (ag._dateISO === filtroData);
          const okHorario = !filtroHorario || (ag._timeHHMM === filtroHorario);
          return okNome && okData && okHorario;
        });

        // renderizar
        if (SHOWN_AGENDAMENTOS.length === 0) {
          grid.innerHTML = '<div class="empty-state">Nenhum agendamento encontrado</div>';
        } else {
          grid.innerHTML = SHOWN_AGENDAMENTOS.map(ag => {
            const nome = escapeHtml(ag.nome || '');
            const displayDate = escapeHtml(ag._displayDate || '');
            const horario = escapeHtml(ag._timeHHMM || '');
            const telefone = escapeHtml(ag.telefone || '');
            const email = escapeHtml(ag.email || '');
            const semana = escapeHtml(ag.semanaGestacao || '');
            const obstetra = escapeHtml(ag.obstetra || '');
            const plano = escapeHtml(ag.planoSaude || '');
            const qualPlano = escapeHtml(ag.qualPlano || '');
            const cidade = escapeHtml(ag.cidade || '');
            const bairro = escapeHtml(ag.bairro || '');
            const como = escapeHtml(ag.comoConheceu || '');
            const obs = escapeHtml(ag.observacoes || '');
            
            const statusClass = status.toString().toLowerCase().includes('pend') ? 'status-pendente' : 'status-confirmado';

            return `
              <div class="agendamento-card">
                <div class="card-header">
                  <h3 class="paciente-nome">${nome}</h3>
                  <div class="agendamento-info"><span class="info-label">Data:</span> ${displayDate} ${horario ? 'às ' + horario : ''}</div>
                </div>

                <div class="agendamento-info"><span class="info-label">Telefone:</span> ${telefone}</div>
                <div class="agendamento-info"><span class="info-label">Email:</span> ${email}</div>
                <div class="agendamento-info"><span class="info-label">Semana de Gestação:</span> ${semana || 'Não informado'}</div>
                <div class="agendamento-info"><span class="info-label">Obstetra:</span> ${obstetra || 'Não informado'}</div>
                <div class="agendamento-info"><span class="info-label">Plano de Saúde:</span> ${plano || 'Não'} ${qualPlano ? '- ' + qualPlano : ''}</div>
                <div class="agendamento-info"><span class="info-label">Localidade:</span> ${cidade || ''} ${cidade && bairro ? '- ' + bairro : bairro || ''}</div>
                <div class="agendamento-info"><span class="info-label">Como conheceu:</span> ${como || 'Não informado'}</div>
                ${obs ? `<div class="agendamento-info"><span class="info-label">Observações:</span> ${obs}</div>` : ''}
                <div class="status-badge ${statusClass}">${status}</div>
              </div>
            `;
          }).join('');
        }

        atualizarEstatisticas(FULL_AGENDAMENTOS);
      } catch (err) {
        console.error('Erro ao carregar agendamentos:', err);
        grid.innerHTML = '<div class="empty-state">Erro ao carregar agendamentos</div>';
        showPanelNotice('Erro ao carregar agendamentos. Veja console para detalhes.', 'error', 5000);
        FULL_AGENDAMENTOS = [];
        SHOWN_AGENDAMENTOS = [];
        atualizarEstatisticas([]);
      }
    }

    // ============ ESTATÍSTICAS ============
    function atualizarEstatisticas(fullList) {
      const todayISO = new Date().toISOString().split('T')[0];
      const monthPrefix = todayISO.slice(0,7);

      const total = fullList.length;
      const hojeCount = fullList.filter(a => (a._dateISO === todayISO)).length;
      const mesCount = fullList.filter(a => (a._dateISO || '').startsWith(monthPrefix)).length;

      document.getElementById('totalAgendamentos').textContent = total;
      document.getElementById('agendamentosHoje').textContent = hojeCount;
      document.getElementById('agendamentosNoMes').textContent = mesCount;
    }

    // ============ EXPORTAÇÃO ============
    function exportarExcel() {
      const lista = Array.isArray(SHOWN_AGENDAMENTOS) ? SHOWN_AGENDAMENTOS : [];
      if (lista.length === 0) { alert('Nenhum agendamento para exportar'); return; }

      const dados = [];
      dados.push(['Nome','Data','Horário','Telefone','Email','Semana Gestação','Obstetra','Plano Saúde','Qual Plano','Cidade','Bairro','Como Conheceu','Observações','Status']);

      for (const ag of lista) {
        dados.push([ ag.nome||'', ag._dateISO||'', ag._timeHHMM||'', ag.telefone||'', ag.email||'', ag.semanaGestacao||'', ag.obstetra||'', ag.planoSaude||'', ag.qualPlano||'', ag.cidade||'', ag.bairro||'', ag.comoConheceu||'', ag.observacoes||'', ag.status||'Pendente' ]);
      }

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(dados);
      XLSX.utils.book_append_sheet(wb, ws, 'Agendamentos');
      XLSX.writeFile(wb, `agendamentos_${new Date().toISOString().split('T')[0]}.xlsx`);
    }

    // ============ UTIL/NOTICES ============
    function showPanelNotice(msg, type='error', ms=4000) {
      const el = document.getElementById('panelNotice');
      el.className = 'notice ' + (type === 'success' ? 'success' : 'error');
      el.textContent = msg;
      el.style.display = 'block';
      setTimeout(()=> el.style.display = 'none', ms);
    }

    // ============ EVENTOS ============
    document.getElementById('loginBtn').addEventListener('click', login);
    document.getElementById('logoutBtn').addEventListener('click', logout);
    document.getElementById('aplicarFiltrosBtn').addEventListener('click', carregarAgendamentos);
    document.getElementById('exportBtn').addEventListener('click', exportarExcel);
    document.getElementById('pass').addEventListener('keypress', function(e){ if (e.key === 'Enter') login(); });

    window.onload = function() {
      if (localStorage.getItem('logado') === 'sim') {
        document.getElementById('loginDiv').style.display = 'none';
        document.getElementById('panelDiv').style.display = 'block';
        carregarAgendamentos();
      }
    };
  </script>
</body>
</html>

